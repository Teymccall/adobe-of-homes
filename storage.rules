rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return request.auth.uid == userId;
    }
    
    function getUserData() {
      return firestore.get(/databases/(default)/documents/users/$(request.auth.uid)).data;
    }
    
    function hasRole(role) {
      return isAuthenticated() && getUserData().role == role;
    }
    
    function hasAnyRole(roles) {
      return isAuthenticated() && getUserData().role in roles;
    }
    
    function isValidImageFile() {
      return request.resource.contentType.matches('image/.*') &&
             request.resource.size < 10 * 1024 * 1024; // 10MB max
    }
    
    function isValidDocumentFile() {
      return (request.resource.contentType.matches('image/.*') ||
              request.resource.contentType == 'application/pdf') &&
             request.resource.size < 5 * 1024 * 1024; // 5MB max
    }

    // Property images
    match /properties/{propertyId}/{allPaths=**} {
      // Property owners can upload images for their properties
      allow write: if isAuthenticated() && 
        hasRole('home_owner') && 
        isValidImageFile();
      
      // Anyone can read property images for verified properties
      allow read: if true;
      
      // Admins can manage all property images
      allow read, write: if hasRole('admin');
    }

    // User profile images
    match /profiles/home_owner/{userId}/{allPaths=**} {
      // Users can upload their own profile image
      allow write: if isOwner(userId) && 
        hasRole('home_owner') && 
        isValidImageFile();
      
      // Anyone can read profile images
      allow read: if true;
      
      // Admins can manage all profile images
      allow read, write: if hasRole('admin');
    }

    match /profiles/artisan/{userId}/{allPaths=**} {
      // Artisans can upload their own profile image
      allow write: if isOwner(userId) && 
        hasRole('artisan') && 
        isValidImageFile();
      
      // Anyone can read artisan profile images
      allow read: if true;
      
      // Admins can manage all profile images
      allow read, write: if hasRole('admin');
    }

    match /profiles/admin/{userId}/{allPaths=**} {
      // Admins can upload their own profile image
      allow write: if isOwner(userId) && 
        hasRole('admin') && 
        isValidImageFile();
      
      // Only admins can read admin profile images
      allow read: if hasRole('admin');
    }

    match /profiles/staff/{userId}/{allPaths=**} {
      // Staff can upload their own profile image
      allow write: if isOwner(userId) && 
        hasRole('staff') && 
        isValidImageFile();
      
      // Admins and staff can read staff profile images
      allow read: if hasAnyRole(['admin', 'staff']);
    }

    // ID documents
    match /documents/{userId}/{allPaths=**} {
      // Users can upload their own ID documents
      allow write: if isOwner(userId) && 
        isValidDocumentFile();
      
      // Users can read their own documents
      allow read: if isOwner(userId);
      
      // Admins and staff can read all documents for verification
      allow read: if hasAnyRole(['admin', 'staff']);
      
      // Admins can manage all documents
      allow write: if hasRole('admin');
    }

    // Artisan portfolio/work images
    match /artisans/{artisanId}/{allPaths=**} {
      // Artisans can upload their work images
      allow write: if isOwner(artisanId) && 
        hasRole('artisan') && 
        isValidImageFile();
      
      // Anyone can read artisan work images
      allow read: if true;
      
      // Admins can manage all artisan images
      allow read, write: if hasRole('admin');
    }

    // Default deny all other operations
    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
} 